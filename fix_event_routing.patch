--- Key Fixes for Event Routing and Duplicate Signal Processing ---

1. STRATEGY CONTAINER FIXES:
   - Remove external SIGNAL publishing for main container (only sub-containers publish to parent)
   - Use internal event bus for parent communication
   - Add signal deduplication with processed_signals tracking
   - Sub-containers only publish to PARENT scope, not GLOBAL

2. PORTFOLIO CONTAINER FIXES:
   - Remove external SIGNAL publishing completely
   - Only forward signals to parent via internal bus
   - Add signal deduplication to prevent duplicate processing
   - Keep external subscriptions for BAR/INDICATORS only

3. RISK CONTAINER FIXES:
   - Remove external SIGNAL subscription (signals come via internal bus from child)
   - Add time-window based signal deduplication (1 second window)
   - Clean up old signal entries to prevent memory leak
   - Only publish ORDERs externally to ExecutionContainer

4. EVENT FLOW FIXES:
   OLD (causing cycles):
   Strategy → External → Portfolio → External → Risk → External → Risk (duplicate!)
            ↘ Internal ↗           ↘ Internal ↗      ↘ Internal ↗

   NEW (no cycles):
   Strategy → Internal → Portfolio → Internal → Risk → External → Execution
   (sub)                 (parent)                      (ORDER only)

5. KEY CHANGES:
   - Internal bus for parent-child SIGNAL communication
   - External bus only for cross-hierarchy events (ORDER to Execution)
   - Deduplication at each level prevents duplicate processing
   - Time-window deduplication in Risk prevents rapid-fire duplicates

6. POSITION SIZING FIX:
   - The overleveraging was caused by duplicate signal processing
   - With deduplication, each signal generates only one order
   - Risk limits will now be properly enforced

To apply these fixes:
1. Update StrategyContainer to use internal bus for parent communication
2. Update PortfolioContainer to remove external SIGNAL publishing
3. Update RiskContainer to remove external SIGNAL subscription
4. Add deduplication logic at each container level
5. Test with multi_strategy_test.yaml to verify single order generation